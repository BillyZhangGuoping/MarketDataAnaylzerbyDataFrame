# encoding: UTF-8
from pymongo import MongoClient,ASCENDING
import pandas as pd

class DataAnalyzer(object):
    def __init__(self,mongohost,mongoport,db,collection,exportpath = "C:\Project\\"):
        self.mongohost = mongohost
        self.mongoport = mongoport
        self.db = db
        self.collection = collection
        self.df = pd.DataFrame()
        self.exportpath = exportpath

    def db2df(self,start,datformat = ['datetime', 'high', 'low', 'open', 'close'],export2xls = True):
        dbClient = MongoClient(self.mongohost, self.mongoport, connectTimeoutMS=500)
        db = dbClient[self.db]
        cursor = db[self.collection].find({'datetime': {'$gte': start}}).sort("datetime", ASCENDING)
        self.df = pd.DataFrame(list(cursor))
        self.df = self.df[datformat]
        self.df = self.df.reset_index(drop=True)
        path = self.exportpath + self.collection + ".xlsx"
        if export2xls == True:
            self.df.to_excel(path , index=True, header=True)
        return self.df

    def df2Barmin(self, inputdf, barmins,crossmin = 1,export2xls = True):
        dfbarmin = pd.DataFrame()
        highBarMin = 0
        lowBarMin = 0
        openBarMin = 0
        closeBarMin = 0
        datetime = 0
        for i in range(0, len(inputdf) - 1):
            bar = inputdf.iloc[i, :].to_dict()
            if openBarMin == 0:
                openBarmin = bar["open"]
            if highBarMin == 0:
                highBarMin = bar["high"]
            else:
                highBarMin = max(bar["high"], highBarMin)

            if lowBarMin == 0:
                lowBarMin = bar["low"]
            else:
                lowBarMin = min(bar["low"], lowBarMin)
            closeBarMin = bar["close"]
            datetime = bar["datetime"]
            # X分钟已经走完
            if not (bar["datetime"].minute + crossmin) % barmins:  # 可以用X整除
                # 生成上一X分钟K线的时间戳
                barMin = {'datetime': datetime, 'high': highBarMin, 'low': lowBarMin, 'open': openBarmin,
                          'close': closeBarMin}
                dfbarmin = dfbarmin.append(barMin, ignore_index=True)
                highBarMin = 0
                lowBarMin = 0
                openBarMin = 0

        if export2xls == True:
            dfbarmin.to_excel(self.exportpath + self.collection + str(barmins) + ".xlsx" , index=True, header=True)
        return dfbarmin
